name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Update root dependencies
        run: |
          npm update
          npm audit fix

      - name: Update backend dependencies
        run: |
          cd backend
          npm update
          npm audit fix

      - name: Update frontend dependencies
        run: |
          cd frontend
          npm update
          npm audit fix

      - name: Run tests after updates
        run: |
          npm run test
          cd backend && npm run test
          cd ../frontend && npm run test

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies"
          title: "Weekly Dependency Updates"
          body: |
            This PR updates project dependencies to their latest versions.

            ## Changes
            - Updated root dependencies
            - Updated backend dependencies
            - Updated frontend dependencies
            - Fixed security vulnerabilities

            ## Testing
            - All tests pass
            - No breaking changes detected

            Please review and test thoroughly before merging.
          branch: dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated

  update-docker-images:
    name: Update Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Docker images
        run: |
          # Update base images in Dockerfiles
          sed -i 's/postgres:15-alpine/postgres:15-alpine/g' docker-compose.prod.yml
          sed -i 's/node:18-alpine/node:18-alpine/g' backend/Dockerfile.prod
          sed -i 's/nginx:alpine/nginx:alpine/g' docker-compose.prod.yml

      - name: Create pull request for Docker updates
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Docker base images"
          title: "Update Docker Base Images"
          body: |
            This PR updates Docker base images to their latest versions.

            ## Changes
            - Updated PostgreSQL base image
            - Updated Node.js base image
            - Updated Nginx base image

            Please review and test the changes.
          branch: docker-updates
          delete-branch: true
          labels: |
            docker
            maintenance